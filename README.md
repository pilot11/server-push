# http服务器推送

本项目是clojure实现的http服务器推送的样例工程。包括服务器部分和网页部分，服务器部分使用clojure编写，网页部分使用clojurescript编写。工程样例中是一些核心实现，只为抛转引玉，真正要达到生产状态，还需要对细节进行完善。

## 技术方案

服务器有消息要发给网页时，可以选择的方案：

1. 网页定期查询：
	* ajax轮询
	* ajax长轮询
	
2. 服务器主动推送：
	* websocket
	* server-sent-events

## 方案比较

方案 | 实现方式 | 优点 | 缺点 
----|----|----|----
ajax轮询 | 网页端定期向服务器查询 | 实现简单，浏览器兼容性高 | 效率低，大量请求无有效返回，服务器压力大，实时性低
ajax长轮询 | ajax轮询的小改进，在没有有效内容响应时，把连接保持到有内容响应的时候 | 请求次数减少，耗费资源小 | 对http连接进行保持，对线程、超时等管理要求比较高
websocket | 使用http握手协议和独立的数据传输协议 | 双向通信，可跨域，实时性高，可传二进制数据 | 协议比http多，服务要增加额外的特性支持，比较重量级，资源消耗大
server-sent-events | 基于现有http协议的流式响应，实现简单 | 轻量级，断线自动重连，可跨域，实时性高 | 只能单向通信，IE不支持，只能传文本格式内容不能传二进制内容

## 踩过的坑
* server-sent-events 推送的消息格式有标准，不符合标准的消息可能在不同的浏览器或者http库上的体现不一致。
* websocket、server-sent-events 可能存在代理服务或其他http中间设备支持不佳的情况，而导致可用性不高。实际使用中可以使借助TLS，通过建立一条端到端的加密信道，可以让通信绕过所有中间代理。
* 部分浏览器已经禁止在http协议下建立websocket连接，需要更改为https。把网站都改为https是一种趋势，https部署要用的CA证书成本也越来越低，甚至还有社区免费版。
* 浏览器对同一个域名的连接数有限制，一般还是个位数级别的，比如，Chrome该数值为6。



